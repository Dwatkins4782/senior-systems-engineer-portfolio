name: Ansible Configuration Management

on:
  push:
    branches: [main, develop]
    paths:
      - 'ansible/**'
      - '.github/workflows/ansible.yml'
  pull_request:
    branches: [main]
    paths:
      - 'ansible/**'
  workflow_dispatch:
    inputs:
      playbook:
        description: 'Playbook to run'
        required: true
        type: choice
        options:
          - site.yml
          - linux-hardening.yml
      limit:
        description: 'Limit to specific hosts (optional)'
        required: false
        type: string

env:
  ANSIBLE_VERSION: '2.15'
  PYTHON_VERSION: '3.11'

permissions:
  contents: read
  pull-requests: write

jobs:
  lint:
    name: Lint Ansible
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ansible==${{ env.ANSIBLE_VERSION }}
          pip install ansible-lint yamllint
      
      - name: Run yamllint
        run: |
          yamllint ansible/
        continue-on-error: true
      
      - name: Run ansible-lint
        run: |
          ansible-lint ansible/playbooks/
        continue-on-error: true
      
      - name: Syntax check playbooks
        run: |
          cd ansible
          for playbook in playbooks/*.yml; do
            echo "Checking $playbook"
            ansible-playbook --syntax-check "$playbook" -i inventory/example.ini
          done

  dry-run:
    name: Dry Run
    runs-on: ubuntu-latest
    needs: lint
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible==${{ env.ANSIBLE_VERSION }}
      
      - name: Run playbook in check mode
        run: |
          cd ansible
          ansible-playbook playbooks/site.yml \
            -i inventory/example.ini \
            --check \
            --diff
        continue-on-error: true

  execute:
    name: Execute Playbook
    runs-on: ubuntu-latest
    needs: lint
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible==${{ env.ANSIBLE_VERSION }}
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.ANSIBLE_HOST }} >> ~/.ssh/known_hosts
      
      - name: Run Ansible Playbook
        run: |
          cd ansible
          LIMIT_FLAG="${{ github.event.inputs.limit && format('--limit {0}', github.event.inputs.limit) || '' }}"
          ansible-playbook playbooks/${{ github.event.inputs.playbook }} \
            -i inventory/production.ini \
            $LIMIT_FLAG \
            -v
